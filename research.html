<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Research</title>
  <style>
*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.19 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}body{margin:0;font-family:IBM Plex Sans,Segoe UI,sans-serif;background:var(--bg);color:var(--text)}.rm-app{min-height:100vh}.rm-header{display:flex;align-items:center;justify-content:space-between;border-bottom-width:1px;padding:1rem 1.25rem;border-color:var(--line);background:color-mix(in srgb,var(--panel) 92%,#f8fafc)}.rm-header h1{margin:0;font-size:1.5rem;line-height:2rem;font-weight:600}.rm-header p{margin:0;font-size:.875rem;line-height:1.25rem;color:var(--muted)}.rm-header-actions{display:flex;gap:.5rem}.rm-icon-btn{height:2.25rem;width:2.25rem;cursor:pointer;border-radius:.5rem;border-width:1px;font-size:1rem;line-height:1.5rem;border-color:var(--line);background:var(--panel);color:var(--text)}.rm-main{display:grid;gap:1rem;padding:1rem;grid-template-columns:340px 1fr}.rm-left,.rm-right{border-radius:.75rem;border-width:1px;padding:1rem;background:var(--panel);border-color:var(--line)}.rm-left h2,.rm-right h2{margin-top:0;margin-bottom:.75rem;font-size:.875rem;line-height:1.25rem;text-transform:uppercase;letter-spacing:.025em;color:var(--muted)}.rm-form input,.rm-form textarea,.rm-snippet-form input,.rm-snippet-form textarea,.rm-toolbar input,.rm-toolbar select{margin-bottom:.5rem;width:100%;border-radius:.375rem;border-width:1px;padding:.5rem .75rem;font-size:.875rem;line-height:1.25rem;border-color:var(--line);background:color-mix(in srgb,var(--panel) 90%,#f8fafc);color:var(--text)}.rm-row{display:flex;gap:.5rem}.rm-btn{cursor:pointer;border-radius:.375rem;border-width:1px;padding:.375rem .75rem;font-size:.875rem;line-height:1.25rem;border-color:color-mix(in srgb,var(--accent) 45%,var(--line));background:color-mix(in srgb,var(--accent) 14%,var(--panel));color:var(--text)}.rm-btn-muted{border-color:var(--line);background:color-mix(in srgb,var(--panel) 86%,#f8fafc)}.rm-divider{margin-top:.75rem;margin-bottom:.75rem;border-top-width:1px;border-color:var(--line)}.rm-active-filters,.rm-tags{display:flex;flex-wrap:wrap;gap:.5rem}.rm-tag{cursor:pointer;border-radius:9999px;border-width:1px;padding:.25rem .625rem;font-size:.75rem;line-height:1rem;border-color:var(--line);background:color-mix(in srgb,var(--panel) 88%,#f8fafc);color:var(--text)}.rm-tag.active{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 18%,var(--panel))}.rm-toolbar{margin-bottom:.75rem;display:grid;gap:.5rem;grid-template-columns:1fr 140px auto}.rm-items{display:flex;flex-direction:column;gap:.75rem}.rm-item{border-radius:.5rem;border-width:1px;padding:.75rem;border-color:var(--line);background:color-mix(in srgb,var(--panel) 95%,#f8fafc)}.rm-item-head{display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem}.rm-item-title{margin:0;font-size:1rem;line-height:1.5rem;font-weight:600}.rm-item-url{word-break:break-all;text-decoration-line:none;color:var(--accent)}.rm-item-note,.rm-item-url{font-size:.875rem;line-height:1.25rem}.rm-item-note{margin-top:.5rem;white-space:pre-wrap;color:color-mix(in srgb,var(--text) 85%,var(--muted))}.rm-item-actions{display:flex;gap:.25rem}.rm-mini-btn{cursor:pointer;border-radius:.25rem;border-width:1px;padding:.25rem .5rem;font-size:.75rem;line-height:1rem;border-color:var(--line);background:var(--panel);color:var(--text)}.rm-snippets{margin-top:.5rem;border-top-width:1px;padding-top:.5rem;border-color:var(--line)}.rm-snippet{margin-bottom:.5rem;border-radius:.25rem;border-width:1px;padding:.5rem;font-size:.875rem;line-height:1.25rem;border-color:var(--line);background:color-mix(in srgb,var(--panel) 88%,#f8fafc)}.rm-snippet q{display:block;font-style:normal}.rm-snippet-note{margin-top:.25rem}.rm-meta,.rm-snippet-note{font-size:.75rem;line-height:1rem;color:var(--muted)}.rm-meta{margin-top:.5rem}.rm-empty{font-size:.875rem;line-height:1.25rem;color:var(--muted)}.rm-error{margin-top:.25rem;font-size:.75rem;line-height:1rem;--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.hidden{display:none}@media (max-width:980px){.rm-main,.rm-toolbar{grid-template-columns:1fr}}.hidden{display:none}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}:root{--bg:#f1f5f9;--panel:#fff;--text:#0f172a;--muted:#64748b;--line:#dbe3ee;--accent:#0ea5e9}[data-theme=dark]{--bg:#0b1220;--panel:#111827;--text:#e2e8f0;--muted:#94a3b8;--line:#334155;--accent:#38bdf8}
  </style>
</head>

<body>
  <div class="rm-app">
    <header class="rm-header">
      <div>
        <h1>Research Manager</h1>
        <p>Save links, snippets, and notes</p>
      </div>
      <div class="rm-header-actions">
        <button id="dashboard-btn" class="rm-icon-btn" aria-label="Go to dashboard" title="Go to dashboard">⌂</button>
        <button id="theme-toggle" class="rm-icon-btn" aria-label="Switch theme" title="Switch theme"></button>
      </div>
    </header>

    <main class="rm-main">
      <section class="rm-left">
        <h2 id="form-title">Add Resource</h2>
        <form id="item-form" class="rm-form">
          <input id="item-title" type="text" placeholder="Title (optional)">
          <input id="item-url" type="text" placeholder="https://example.com/article" required>
          <textarea id="item-note" rows="4" placeholder="Notes"></textarea>
          <input id="item-tags" type="text" placeholder="Tags (comma separated)">
          <div class="rm-row">
            <button type="submit" id="save-item-btn" class="rm-btn">Save</button>
            <button type="button" id="cancel-edit-btn" class="rm-btn rm-btn-muted hidden">Cancel</button>
          </div>
          <p id="form-error" class="rm-error hidden"></p>
        </form>

        <div class="rm-divider"></div>

        <h2>Tags</h2>
        <div id="tag-catalog" class="rm-tags"></div>
      </section>

      <section class="rm-right">
        <div class="rm-toolbar">
          <input id="search-input" type="text" placeholder="Search title, URL, notes, tags, snippets">
          <select id="sort-select">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="title">Title</option>
          </select>
          <button id="export-btn" class="rm-btn">Export Markdown</button>
        </div>

        <div id="active-filters" class="rm-active-filters hidden"></div>

        <div id="items-list" class="rm-items"></div>
        <p id="empty-state" class="rm-empty hidden">No resources yet.</p>
      </section>
    </main>
  </div>

  <script>
(function () {
  const KEY = 'spa-theme';
  const VALID = new Set(['dark', 'light']);
  let initialized = false;

  function normalize(mode) {
    return VALID.has(mode) ? mode : null;
  }

  function readStored() {
    try {
      return normalize(localStorage.getItem(KEY));
    } catch {
      return null;
    }
  }

  function apply(mode) {
    document.documentElement.dataset.theme = mode;
    document.documentElement.style.colorScheme = mode;
  }

  function emit(mode) {
    window.dispatchEvent(new CustomEvent('themechange', { detail: { mode } }));
  }

  function get() {
    return normalize(document.documentElement.dataset.theme) || 'dark';
  }

  function set(mode, persist = true) {
    const normalized = normalize(mode) || 'dark';
    apply(normalized);
    if (persist) {
      try {
        localStorage.setItem(KEY, normalized);
      } catch {
        // ignore storage failures
      }
    }
    emit(normalized);
    return normalized;
  }

  function init(options = {}) {
    const fallback = normalize(options.defaultMode) || 'dark';
    const stored = readStored();
    const mode = stored || fallback;
    apply(mode);
    if (!stored) {
      try {
        localStorage.setItem(KEY, mode);
      } catch {
        // ignore storage failures
      }
    }
    if (!initialized) {
      emit(mode);
      initialized = true;
    }
    return mode;
  }

  function toggle() {
    return set(get() === 'dark' ? 'light' : 'dark');
  }

  function mountToggle(button, options = {}) {
    if (!button) return;

    const darkIcon = options.darkIcon || '☀';
    const lightIcon = options.lightIcon || '☾';

    const sync = () => {
      const mode = get();
      const next = mode === 'dark' ? 'light' : 'dark';
      button.textContent = mode === 'dark' ? darkIcon : lightIcon;
      button.setAttribute('aria-label', `Switch to ${next} mode`);
      button.setAttribute('title', `Switch to ${next} mode`);
      button.dataset.mode = mode;
    };

    button.addEventListener('click', () => toggle());
    window.addEventListener('themechange', sync);
    sync();
  }

  window.Theme = {
    init,
    get,
    set,
    toggle,
    mountToggle,
  };

  window.AppNav = {
    goDashboard() {
      window.location.href = 'dashboard.html';
    },
  };
})();
  </script>
  <script>
function dbOpen() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('research-app', 1);
    req.onupgradeneeded = () => {
      if (!req.result.objectStoreNames.contains('state')) {
        req.result.createObjectStore('state');
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbGet(db, key) {
  return new Promise((resolve, reject) => {
    const req = db.transaction('state').objectStore('state').get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbPut(db, key, value) {
  return new Promise((resolve, reject) => {
    const req = db.transaction('state', 'readwrite').objectStore('state').put(value, key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

const state = {
  db: null,
  items: [],
  tagCatalog: [],
  ui: {
    query: '',
    selectedTags: [],
    sort: 'newest',
  },
  editingId: null,
  snippetDraftByItem: {},
};

const el = {
  formTitle: document.getElementById('form-title'),
  form: document.getElementById('item-form'),
  title: document.getElementById('item-title'),
  url: document.getElementById('item-url'),
  note: document.getElementById('item-note'),
  tags: document.getElementById('item-tags'),
  saveBtn: document.getElementById('save-item-btn'),
  cancelEdit: document.getElementById('cancel-edit-btn'),
  formError: document.getElementById('form-error'),
  search: document.getElementById('search-input'),
  sort: document.getElementById('sort-select'),
  exportBtn: document.getElementById('export-btn'),
  itemsList: document.getElementById('items-list'),
  emptyState: document.getElementById('empty-state'),
  tagCatalog: document.getElementById('tag-catalog'),
  activeFilters: document.getElementById('active-filters'),
  themeToggle: document.getElementById('theme-toggle'),
  dashboardBtn: document.getElementById('dashboard-btn'),
};

function uid(prefix) {
  return prefix + '_' + Math.random().toString(36).slice(2, 9);
}

function parseTags(raw) {
  return [...new Set(
    raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean)
  )];
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function formatDate(ts) {
  return new Date(ts).toLocaleString();
}

function validateUrl(raw) {
  const input = raw.trim();
  if (!input) return { ok: false, error: 'URL is required' };
  let url = input;
  if (!/^https?:\/\//i.test(url)) {
    url = 'https://' + url;
  }
  try {
    const parsed = new URL(url);
    return { ok: true, value: parsed.toString() };
  } catch {
    return { ok: false, error: 'Enter a valid URL' };
  }
}

function upsertTagCatalog(items) {
  const seen = new Set();
  items.forEach(item => item.tags.forEach(tag => seen.add(tag)));
  state.tagCatalog = [...seen].sort((a, b) => a.localeCompare(b));
}

async function persist() {
  await dbPut(state.db, 'items', state.items);
  await dbPut(state.db, 'tagCatalog', state.tagCatalog);
  await dbPut(state.db, 'ui', state.ui);
}

function resetForm() {
  state.editingId = null;
  el.formTitle.textContent = 'Add Resource';
  el.saveBtn.textContent = 'Save';
  el.cancelEdit.classList.add('hidden');
  el.title.value = '';
  el.url.value = '';
  el.note.value = '';
  el.tags.value = '';
  el.formError.classList.add('hidden');
  el.formError.textContent = '';
}

function populateForm(item) {
  state.editingId = item.id;
  el.formTitle.textContent = 'Edit Resource';
  el.saveBtn.textContent = 'Update';
  el.cancelEdit.classList.remove('hidden');
  el.title.value = item.title;
  el.url.value = item.url;
  el.note.value = item.note;
  el.tags.value = item.tags.join(', ');
}

function normalizedSearchText(item) {
  const snippetText = item.snippets.map(s => `${s.text} ${s.note}`).join(' ');
  return [
    item.title,
    item.url,
    item.note,
    item.tags.join(' '),
    snippetText,
  ].join(' ').toLowerCase();
}

function filteredItems() {
  const query = state.ui.query.trim().toLowerCase();
  let items = state.items.filter(item => {
    const queryMatch = !query || normalizedSearchText(item).includes(query);
    const tagsMatch = state.ui.selectedTags.length === 0
      || state.ui.selectedTags.some(tag => item.tags.includes(tag));
    return queryMatch && tagsMatch;
  });

  if (state.ui.sort === 'newest') {
    items.sort((a, b) => b.createdAt - a.createdAt);
  } else if (state.ui.sort === 'oldest') {
    items.sort((a, b) => a.createdAt - b.createdAt);
  } else {
    items.sort((a, b) => (a.title || a.url).localeCompare(b.title || b.url));
  }
  return items;
}

function renderTags() {
  el.tagCatalog.innerHTML = '';
  state.tagCatalog.forEach(tag => {
    const b = document.createElement('button');
    b.className = 'rm-tag' + (state.ui.selectedTags.includes(tag) ? ' active' : '');
    b.textContent = tag;
    b.addEventListener('click', () => {
      if (state.ui.selectedTags.includes(tag)) {
        state.ui.selectedTags = state.ui.selectedTags.filter(t => t !== tag);
      } else {
        state.ui.selectedTags.push(tag);
      }
      persist();
      render();
    });
    el.tagCatalog.appendChild(b);
  });

  el.activeFilters.innerHTML = '';
  if (state.ui.selectedTags.length === 0) {
    el.activeFilters.classList.add('hidden');
    return;
  }
  el.activeFilters.classList.remove('hidden');
  state.ui.selectedTags.forEach(tag => {
    const chip = document.createElement('button');
    chip.className = 'rm-tag active';
    chip.textContent = tag + ' ×';
    chip.addEventListener('click', () => {
      state.ui.selectedTags = state.ui.selectedTags.filter(t => t !== tag);
      persist();
      render();
    });
    el.activeFilters.appendChild(chip);
  });
}

function snippetDraft(itemId) {
  return state.snippetDraftByItem[itemId] || { text: '', note: '' };
}

function setSnippetDraft(itemId, patch) {
  const curr = snippetDraft(itemId);
  state.snippetDraftByItem[itemId] = { ...curr, ...patch };
}

function buildSnippetForm(item) {
  const draft = snippetDraft(item.id);
  return `
    <div class="rm-snippet-form">
      <textarea data-snippet-text="${item.id}" rows="2" placeholder="Snippet text">${escapeHtml(draft.text)}</textarea>
      <input data-snippet-note="${item.id}" type="text" placeholder="Snippet note (optional)" value="${escapeHtml(draft.note)}">
      <button data-snippet-add="${item.id}" class="rm-mini-btn">Add snippet</button>
    </div>
  `;
}

function renderItems() {
  const items = filteredItems();
  el.itemsList.innerHTML = '';

  items.forEach(item => {
    const card = document.createElement('article');
    card.className = 'rm-item';
    const title = item.title || new URL(item.url).hostname;
    card.innerHTML = `
      <div class="rm-item-head">
        <div>
          <p class="rm-item-title">${escapeHtml(title)}</p>
          <a class="rm-item-url" href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer">${escapeHtml(item.url)}</a>
        </div>
        <div class="rm-item-actions">
          <button class="rm-mini-btn" data-item-edit="${item.id}">Edit</button>
          <button class="rm-mini-btn" data-item-delete="${item.id}">Delete</button>
        </div>
      </div>
      ${item.note ? `<p class="rm-item-note">${escapeHtml(item.note)}</p>` : ''}
      <div class="rm-tags">
        ${item.tags.map(tag => `<span class="rm-tag">${escapeHtml(tag)}</span>`).join('')}
      </div>
      <div class="rm-snippets">
        <strong>Snippets (${item.snippets.length})</strong>
        ${item.snippets.map(sn => `
          <div class="rm-snippet">
            <q>${escapeHtml(sn.text)}</q>
            ${sn.note ? `<div class="rm-snippet-note">${escapeHtml(sn.note)}</div>` : ''}
            <div class="rm-item-actions" style="margin-top:6px">
              <button class="rm-mini-btn" data-snippet-edit="${item.id}:${sn.id}">Edit</button>
              <button class="rm-mini-btn" data-snippet-delete="${item.id}:${sn.id}">Delete</button>
            </div>
          </div>
        `).join('')}
        ${buildSnippetForm(item)}
      </div>
      <p class="rm-meta">Saved ${formatDate(item.createdAt)} · Updated ${formatDate(item.updatedAt)}</p>
    `;
    el.itemsList.appendChild(card);
  });

  el.emptyState.textContent = state.items.length === 0
    ? 'No resources yet.'
    : 'No results for current filters.';
  el.emptyState.classList.toggle('hidden', items.length > 0);
}

function render() {
  el.search.value = state.ui.query;
  el.sort.value = state.ui.sort;
  renderTags();
  renderItems();
}

function findItem(itemId) {
  return state.items.find(item => item.id === itemId);
}

function onFormSubmit(e) {
  e.preventDefault();
  const valid = validateUrl(el.url.value);
  if (!valid.ok) {
    el.formError.textContent = valid.error;
    el.formError.classList.remove('hidden');
    return;
  }
  el.formError.classList.add('hidden');

  const now = Date.now();
  const payload = {
    title: el.title.value.trim(),
    url: valid.value,
    note: el.note.value.trim(),
    tags: parseTags(el.tags.value),
    updatedAt: now,
  };

  if (state.editingId) {
    const item = findItem(state.editingId);
    if (!item) return;
    Object.assign(item, payload);
  } else {
    state.items.unshift({
      id: uid('item'),
      ...payload,
      snippets: [],
      createdAt: now,
    });
  }

  upsertTagCatalog(state.items);
  persist();
  resetForm();
  render();
}

function editSnippet(itemId, snippetId) {
  const item = findItem(itemId);
  if (!item) return;
  const snippet = item.snippets.find(s => s.id === snippetId);
  if (!snippet) return;
  const text = window.prompt('Snippet text', snippet.text);
  if (text === null) return;
  const trimmed = text.trim();
  if (!trimmed) return;
  const note = window.prompt('Snippet note (optional)', snippet.note || '');
  snippet.text = trimmed;
  snippet.note = note === null ? snippet.note : note.trim();
  item.updatedAt = Date.now();
  persist();
  render();
}

function exportMarkdown() {
  if (state.items.length === 0) return;

  const byTag = new Map();
  byTag.set('Untagged', []);
  state.items.forEach(item => {
    if (item.tags.length === 0) {
      byTag.get('Untagged').push(item);
      return;
    }
    item.tags.forEach(tag => {
      if (!byTag.has(tag)) byTag.set(tag, []);
      byTag.get(tag).push(item);
    });
  });

  const lines = ['# Research Export', ''];
  [...byTag.keys()].sort((a, b) => {
    if (a === 'Untagged') return -1;
    if (b === 'Untagged') return 1;
    return a.localeCompare(b);
  }).forEach(tag => {
    const items = byTag.get(tag);
    if (!items || items.length === 0) return;
    lines.push(`## ${tag}`);
    lines.push('');

    items.forEach(item => {
      const title = item.title || item.url;
      lines.push(`### ${title}`);
      lines.push(`- Link: [${item.url}](${item.url})`);
      if (item.note) lines.push(`- Note: ${item.note}`);
      if (item.snippets.length > 0) {
        lines.push('- Snippets:');
        item.snippets.forEach(sn => {
          lines.push(`  - > ${sn.text}`);
          if (sn.note) lines.push(`    - Note: ${sn.note}`);
        });
      }
      lines.push(`- Saved: ${new Date(item.createdAt).toISOString()}`);
      lines.push(`- Updated: ${new Date(item.updatedAt).toISOString()}`);
      lines.push('');
    });
  });

  const blob = new Blob([lines.join('\n')], { type: 'text/markdown' });
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  a.href = url;
  a.download = `research-export-${y}-${m}-${day}.md`;
  a.click();
  URL.revokeObjectURL(url);
}

function bindDynamicActions() {
  el.itemsList.addEventListener('click', e => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;

    const editItemId = target.getAttribute('data-item-edit');
    if (editItemId) {
      const item = findItem(editItemId);
      if (item) populateForm(item);
      return;
    }

    const deleteItemId = target.getAttribute('data-item-delete');
    if (deleteItemId) {
      state.items = state.items.filter(i => i.id !== deleteItemId);
      if (state.editingId === deleteItemId) resetForm();
      upsertTagCatalog(state.items);
      persist();
      render();
      return;
    }

    const addSnippetItemId = target.getAttribute('data-snippet-add');
    if (addSnippetItemId) {
      const item = findItem(addSnippetItemId);
      if (!item) return;
      const draft = snippetDraft(item.id);
      const text = draft.text.trim();
      if (!text) return;
      item.snippets.push({
        id: uid('snip'),
        text,
        note: draft.note.trim(),
        createdAt: Date.now(),
      });
      item.updatedAt = Date.now();
      state.snippetDraftByItem[item.id] = { text: '', note: '' };
      persist();
      render();
      return;
    }

    const deleteSnippet = target.getAttribute('data-snippet-delete');
    if (deleteSnippet) {
      const [itemId, snippetId] = deleteSnippet.split(':');
      const item = findItem(itemId);
      if (!item) return;
      item.snippets = item.snippets.filter(s => s.id !== snippetId);
      item.updatedAt = Date.now();
      persist();
      render();
      return;
    }

    const editSnippetAttr = target.getAttribute('data-snippet-edit');
    if (editSnippetAttr) {
      const [itemId, snippetId] = editSnippetAttr.split(':');
      editSnippet(itemId, snippetId);
    }
  });

  el.itemsList.addEventListener('input', e => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;
    const textFor = target.getAttribute('data-snippet-text');
    if (textFor && target instanceof HTMLTextAreaElement) {
      setSnippetDraft(textFor, { text: target.value });
      return;
    }
    const noteFor = target.getAttribute('data-snippet-note');
    if (noteFor && target instanceof HTMLInputElement) {
      setSnippetDraft(noteFor, { note: target.value });
    }
  });
}

async function init() {
  Theme.init({ defaultMode: 'dark' });
  Theme.mountToggle(el.themeToggle);
  el.dashboardBtn.addEventListener('click', () => AppNav.goDashboard());

  state.db = await dbOpen();
  state.items = (await dbGet(state.db, 'items')) || [];
  state.tagCatalog = (await dbGet(state.db, 'tagCatalog')) || [];
  state.ui = {
    query: '',
    selectedTags: [],
    sort: 'newest',
    ...(await dbGet(state.db, 'ui') || {}),
  };
  upsertTagCatalog(state.items);

  el.form.addEventListener('submit', onFormSubmit);
  el.cancelEdit.addEventListener('click', resetForm);

  el.search.addEventListener('input', () => {
    state.ui.query = el.search.value;
    persist();
    render();
  });

  el.sort.addEventListener('change', () => {
    state.ui.sort = el.sort.value;
    persist();
    render();
  });

  el.exportBtn.addEventListener('click', exportMarkdown);

  bindDynamicActions();
  render();
}

init();
  </script>
</body>

</html>
